# Оху*тельная история⁠⁠
# Однажды по дороге в школу мне захотелось срать. Переборов в себе порывы, я решил добежать до школьного толкана и там извергнуть свое говно. Но каков был мой ужас, когда я обнаружил, что толкан не работает! А срать хотелось все больше.
#
#
#
# Начался урок, но я не мог идти, я бы просто обосрался по дороге! Но, когда коридор опустел, я обнаружил рядом с собой чей-то портфель. Выбора у меня не оставалось, я расстегнул штаны, стянул труханы и начал срать в тот злосчастный портфель. Срал я очень долго и срал бы еще, если бы не послышались шаги. Все, что я успел сделать, это в спешке натянуть трусы и штаны на свою обосраную жопу, а затем встать по стойке смирно. Торопясь, я забыл застегнуть портфель и это станет огромной проблемой.
#
#
#
# Тут передо мной оказалась хозяйка портфеля - тян из параллельного, на которую я дрочил уже больше года (назовем ее для удобства Катей). Я стоял между ней и ее портфелем, так что она не могла видеть мое говно.
#
#
#
# Увидев меня, она покраснела и потупила взгляд. Я уже подумал было, что у меня ботинки или одежда в дрисне, но быстрый анализ происходящего дал понять, что, вроде бы, все нормально.
#
#
#
# И вдруг Катя начала что-то говорить. Всерьез озабоченный своей проблемой, я практически не слушал ее, а говорила она что-то про какие-то чувства ко мне. Этого мне только не хватало! Надо было срочно придумывать выход из ситуации.
#
#
#
# Еще мое положение несколько усложнялось тем, что мои штаны были не застегнуты и мне приходилось держать руки в карманах, чтобы они не спадали.
#
#
#
# — "Так что ты скажешь?" - вдруг пробился в мой мозг ее голос.
#
#
#
# — "Ну, э..." - старался я потянуть время - "Я влюблен в тебя второй уже второй год, и каждый день думаю только о тебе!" - с этого момента я начал нести какой-то бред, а она смотрела на меня взглядом, полным любви.
#
#
#
# Но в какой-то момент моя жопа начала подавать признаки того, что процесс калоизвержения далеко не закончен! Мой живот скрутило, послышались ужасающие звуки. Я уже понимал, что через несколько минут я обосрусь, а тогда и фейл неизбежен.
#
#
#
# Но в этот момент у Кати зазвонил телефон, а лежал он... В портфеле!
#
#
#
# А еще в портфеле лежала здоровенная куча моего дерьма. Это была самая хуевая и безвыходная ситуация в моей жизни. Тян устремилась к портфелю, но я пошел на последний отчаянный шаг.
#
#
#
# Подбежав к ней, я обнял ее, и наши губы слились в поцелуе! В этот же момент у меня встал член, и он на некоторое время задержал падение штанов с моей жопы.
#
#
#
# Катя прижалась ко мне, и я чудом смог спрятать стояк. От всей охуенности происходящего мне даже расхотелось срать. Я целуюсь с тян моей мечты, а в ее портфеле лежит мое говно. А еще шел урок. И в этот момент меня спас какой-то препод, который решил сходить в соседний кабинет. А так как мы прогуливали, нам с Катей оставалось только ретироваться на лестницу. Под шумок я застегнул штаны, но мы стояли уже на первом этаже.
#
#
#
# И тут Катя заявляет:
#
#
#
# — "Может, пойдем ко мне домой?"
#
#
#
# Я был всей душой за, но нужно было что-то сделать с портфелем!
#
#
#
# Я высказал свое согласие, и тогда Катя без предупреждения пошла вверх за своим рюкзаком! Я молчал, как партизан, мысленно готовясь к полному краху своего счастья.
#
#
#
# Мы поднялись на этаж вверх, где лежал злосчастный портфель. И тут нас уже встречал тот препод.
#
#
#
# Началась немая сцена. Учитель с непониманием смотрел на нас с Катей, а та, в свою очередь, смотрела внутрь своего портфеля.
#
#
#
# Мы так стояли где-то минуту, пока я не спизданул преподу:
#
#
#
# — "Зачем вы насрали в портфель?"
#
#
#
# И тут начался пиздец.
#
#
#
# — "Вы неправильно поняли! Там уже было наложено!"
#
#
#
# Катя молча охуевала, потом схватила меня за руку и начала плакать. Я уже хотел было давать по съебкам, как моя жопа снова начала хотеть извергнуть очередную порцию говна.
#
#
#
# Преодолев и этот позыв, я начал съебывать, утягивая за собой Катю. Препод же настолько охреневал, что не мог даже пошевелиться и трясся.
#
#
#
# Через несколько секунд мы уже стояли в раздевалке и готовились к побегу. Я уже переобулся и был готов, как моя жопа будто сказала - не так быстро, чувак!
#
#
#
# Это был девятый вал. Я схватил первый попавшийся пакет от сменки и начал срать в него.
#
#
#
# В это время Катя искала свой пакет. На мое счастье, этот залп жопа произвела почти моментально. Я быстро повесил пакет на место, и, найдя Катю, хотел было съебывать из школы, как она спросила, не видел ли я желтый пакет с красными кружками. Тот самый, в который я только что насрал.
#
#
#
# Естественно, я ответил, что не видел, а сам, под видом того, что помогал его искать, быстро нашел его и перекинул через перегородку раздевалки. Но за перегородкой был коридор и выход из школы! Это я понял слишком поздно.
#
#
#
# И именно в этот момент Катя предложила мне свалить без пакета. Через секунду мы уже бежали к выходу, я надеялся, что она не заметит пакет.
#
#
#
# Но! Когда, казалось, все обошлось, мы увидели того самого препода, а вдобавок директора, завуча и охранника Петровича, смотрящих на обосранный пакет.
#
#
#
# И тут я ощутил охуенное дежавю и спизданул:
#
#
#
# — "Зачем вы насрали в пакет?"
#
#
#
# Препода тут же хватил удар, и он упал. Все начали вызывать скорую, а мы с Катей по тихому свалили.
#
#
#
# Она верила в то, что все засрал препод, и это было охуенно. Впереди был прекрасный день...

# import necessary packages and dependencies
from flask import Flask, jsonify, request
import pymongo
from bson.objectid import ObjectId

# initialize Flask app
app = Flask(__name__)

# connect to MongoDB database
mongo_client = pymongo.MongoClient('mongodb://localhost:27017/')
mongo_db = mongo_client['games_db']
games_collection = mongo_db['games']
rating_collection = mongo_db['ratings']

# define game schema for MongoDB collection
game_schema = {
    'name': str,
    'author': str,
    'studio': str,
    'date_of_release': str,
    'availability': bool,
    'price': float,
    'rating': list,
    'final_rating': float
}
rating_schema = {
    # the name should be taken from the schema above, so it will be the same
    "name": str,
    # the average will change every time then the new rating is added
    "average": float,
    "rating_1": int
    # "rating_2": int,
    # "rating_3": int
    # add more rating fields as needed
}
comment_schema = {
    "game": str,
    "user": str,
    "type": str,
    "lvl": int,
    "comment": str,
    "rating": int

}


# define endpoint to get games from the MongoDB database
@app.route('/games', methods=['GET'])
def get_all_games():
    game_list = []
    for game in games_collection.find():
        game['_id'] = str(game['_id'])
        game_list.append(game)
    return jsonify(game_list),201


# define endpoint to add games to the MongoDB database
@app.route('/games', methods=['POST'])
def add_game():
    # get game data from request body
    game_data = request.get_json()
    # validate game data
    game_data['rating'] = []
    game_data['final_rating'] = 0
    for key, value_type in game_schema.items(): # Using dict.items() to loop through dict key-value pairs
        if key not in game_data:
            return jsonify({'message': f'Missing {key} parameter in request.'}), 400
        elif not isinstance(game_data[key], value_type): # Use isinstance() to check value type
            return jsonify({'message': f'{key} parameter has incorrect data type.'}), 400
    # insert game data into MongoDB database
    games_collection.insert_one(game_data)
    # TODO: uncomment if rating_collection exists and requires insertion of game_data
    # rating_collection.insert_one(game_data)
    # return success message
    return jsonify({'message': f'{game_data["name"]} added to games collection.'}), 201

    # define endpoint to delete games from the MongoDB database


# pui la cacat

# hleb mocha
# hleb
# mocha
# blea
# pizda
# ya tebe pokaju hui

# new song from KIZYAKA

# ne budi eblanom

# na scene

# NA SCENE

# HHHHHHHHHHHHsUYYYYYYYYYYYYYY

@app.route('/games/rating', methods=['PUT'])
def add_rating():
    game_id = request.json['_id']
    new_rating = request.json['rating']
    game = games_collection.find_one({'_id': ObjectId(game_id)})
    if not game:
        return {'error': 'Game not found'}, 404
    # Calculate the medium rating
    rating = game['rating']
    rating.append(new_rating)
    # Я объявляю мировую революцию
    # Я, Ленин Ульянов, за приватизацию
    # Я ебу собак
    # Всегда готов
    # Трахнуть сразу несколько котов
    final_rating = sum(rating) / len(rating)

    rating = game['rating']
    result = games_collection.update_one({'_id': ObjectId(game_id)}, {'$set': {'rating': rating, 'final_rating': final_rating}})
    return {'final_rating': final_rating}, 201

@app.route('/games', methods=['DELETE'])
def delete_game():
    # get game name from request parameters
    game_name = request.args.get('name')
    # delete game from MongoDB database
    result = games_collection.delete_one({'name': game_name})
    # return success or failure message
    if result.deleted_count > 0:
        return jsonify({'message': f'{game_name} deleted from games collection.'})
    else:
        return jsonify({'message': f'{game_name} not found in games collection.'}), 404


# define endpoint to check the availability and functionality of the Second API
@app.route('/status')
def status():
    # check if MongoDB database is connected
    mongo_status = 'MongoDB database connected.' if mongo_client.server_info() else 'MongoDB database not connected.'
    # return status of Second API and MongoDB database
    return jsonify({'second_api': 'Second API connected.', 'mongo': mongo_status})


# # define endpoint to delete all games from the MongoDB database
# @app.route('/games/delete_all', methods=['DELETE'])
# def delete_all_games():
#     # delete all games from MongoDB database
#     result = games_collection.delete_many({})
#     # return success message
#     return jsonify({'message': f'{result.deleted_count} games deleted from games collection.'}), 200


# run Flask app if executed as main module
if __name__ == '__main__':
    app.run(debug=True, port=5001)
